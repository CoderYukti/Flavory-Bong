<!DOCTYPE html>
<html>

<head>
    <title>Live Orders Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        h1 {
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            padding: 8px 16px;
            background-color: #f2f2f2;
            border-radius: 5px;
            cursor: pointer;
        }

        .tab.active {
            background-color: #007bff;
            color: #fff;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 10px;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            cursor: pointer;
        }

        th {
            background-color: #f2f2f2;
        }

        input,
        select,
        button {
            padding: 5px;
            margin: 5px;
        }

        .pagination {
            margin-top: 10px;
        }

        .pagination button {
            margin: 0 2px;
            padding: 5px 10px;
        }

        .active-page {
            font-weight: bold;
        }

        .pending {
            background-color: #ffe6e6;
        }

        .paid {
            background-color: #e6ffe6;
        }

        .delivered {
            background-color: #e6f7ff;
        }

        .total-row td {
            font-weight: bold;
            background-color: #f9f9f9;
        }

        .item-link {
            text-transform: capitalize;
        }

        #filters {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
    </style>
</head>

<body>
    <h1>Live Orders Dashboard</h1>

    <!-- Tabs -->
    <div class="tabs">
        <div class="tab active" id="tab-delivered" onclick="switchTab('delivered')">Delivered Orders</div>
        <div class="tab" id="tab-orders" onclick="switchTab('orders')">Orders</div>
    </div>


    <!-- Filters -->
    <div id="filters">
        <label>Search:</label>
        <input type="text" id="searchInput" placeholder="Name / Email">
        <div id="paymentFilterWrapper">
            <label>Payment:</label>
            <select id="paymentFilter">
                <option value="">All</option>
                <option value="Paid">Paid</option>
                <option value="Pending">Pending</option>
            </select>
        </div>

        <label>Date From:</label>
        <input type="date" id="dateFrom">
        <label>To:</label>
        <input type="date" id="dateTo">
        <button onclick="loadOrders(true)">Reset</button>
    </div>

    <table id="sheetTable">
        <thead></thead>
        <tbody></tbody>
        <tfoot></tfoot>
    </table>

    <div class="pagination" id="pagination"></div>

    <script>
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxJ8N_uoMC0nPbiNvagwhp8xleIwmhRRqbjIb0yu1aMPkCbYGDGo7b5NtYsUm9qaSFs/exec';
        const rowsPerPage = 10;

        let allData = [];
        let filteredData = [];
        let columns = [];
        let currentPage = 1;
        let sortColumn = null;
        let sortAsc = false;
        let activeTab = 'orders'; // default tab

        // ----------------------
        // ðŸ”¹ Utility Functions
        // ----------------------
        function parseDateFlex(v) {
            if (!v) return null;
            if (v instanceof Date && !isNaN(v)) return new Date(v.getTime());
            if (typeof v === 'number') {
                if (v > 1e12) return new Date(v);
                const epoch = Date.UTC(1899, 11, 30);
                return new Date(epoch + v * 86400000);
            }
            const s = String(v).trim();
            const g = s.match(/^Date\((\d{4}),(\d{1,2}),(\d{1,2})/i);
            if (g) return new Date(+g[1], +g[2], +g[3]);
            if (/^\d{4}-\d{2}-\d{2}/.test(s)) {
                const d = new Date(s);
                return isNaN(d) ? null : d;
            }
            const m = s.match(/^(\d{1,2})[\/.-](\d{1,2})[\/.-](\d{2,4})$/);
            if (m) {
                let [, day, month, year] = m.map(Number);
                if (year < 100) year += 2000;
                return new Date(year, month - 1, day);
            }
            const parsed = Date.parse(s);
            return isNaN(parsed) ? null : new Date(parsed);
        }

        function formatDisplayDate(dateObj) {
            if (!dateObj) return '';
            return dateObj.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }).replace(/ /g, '-');
        }

        function parseDateTime(dateStr, timeStr) {
            const date = parseDateFlex(dateStr);
            if (!date) return null;
            if (!timeStr) return date;

            const t = new Date(timeStr);
            if (!isNaN(t)) {
                date.setHours(t.getHours(), t.getMinutes(), t.getSeconds(), 0);
                return date;
            }

            const match = String(timeStr).trim().toUpperCase().match(/^(\d{1,2}):(\d{2})\s*(AM|PM)?$/i);
            if (match) {
                let hours = +match[1], minutes = +match[2];
                if (match[3] === 'PM' && hours < 12) hours += 12;
                if (match[3] === 'AM' && hours === 12) hours = 0;
                date.setHours(hours, minutes, 0, 0);
            }
            return date;
        }

        function escapeHtml(s) {
            return String(s || '').replace(/[&<>"']/g, ch =>
                ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[ch]);
        }

        // ----------------------
        // ðŸ”¹ Fetch Orders
        // ----------------------
        async function fetchOrders(sheetName) {
            try {
                const res = await fetch(`${APPS_SCRIPT_URL}?sheet=${encodeURIComponent(sheetName)}`);
                const data = await res.json();
                if (!data || !data.length) {
                    allData = [];
                    filteredData = [];
                    displayTable();
                    return;
                }

                if (sheetName === 'Orders') {
                    // Delivered Orders sheet
                    allData = data.map(row => ({
                        dateObj: parseDateFlex(row.date),
                        date: row.date,
                        invoiceNo: row.invoiceNo,
                        customerName: row.customerName,
                        email: row.email,
                        items: row.items,
                        subtotal: parseFloat(row.subtotal) || 0,
                        discount: parseFloat(row.discount) || 0,
                        tax: parseFloat(row.tax) || 0,
                        grandTotal: parseFloat(row.grandTotal) || 0,
                        paymentStatus: row.paymentStatus,
                        notes: row.notes
                    }));
                    columns = ["Date", "Invoice No", "Customer Name", "Email", "Items", "Subtotal", "Discount", "Tax", "Grand Total", "Payment Status", "Notes", "Invoice PDF"];
                } else if (sheetName === 'Future Orders') {
                    // Upcoming Orders sheet
                    allData = data.map(row => {
                        const parsed = parseDateTime(row.deliveryDate, row.deliveryTime);
                        return {
                            dateObj: parseDateFlex(row.date),
                            date: row.date,
                            customerName: row.customerName,
                            email: row.email,
                            deliveryDateObj: parsed,
                            deliveryDate: row.deliveryDate,
                            deliveryTime: row.deliveryTime,
                            items: row.items,
                            notes: row.notes,
                            deliveryStatus: row.deliveryStatus
                        };
                    });
                    columns = ["Date", "Customer Name", "Email", "Delivery Date", "Delivery Time", "Items", "Notes", "Delivery Status"];
                }

                createTableHeader(columns);
                filteredData = [...allData].reverse();
                currentPage = 1;
                displayTable();
            } catch (err) {
                console.error('Fetch error', err);
            }
        }

        // ----------------------
        // ðŸ”¹ Display Functions
        // ----------------------
        function createTableHeader(cols) {
            const thead = document.querySelector('#sheetTable thead');
            thead.innerHTML = '';
            const tr = document.createElement('tr');
            cols.forEach(col => {
                const th = document.createElement('th');
                th.textContent = col;
                if (col !== 'Invoice PDF') th.addEventListener('click', () => sortByColumn(col));
                tr.appendChild(th);
            });
            thead.appendChild(tr);
        }

        function displayTable() {
            const tbody = document.querySelector('#sheetTable tbody');
            const tfoot = document.querySelector('#sheetTable tfoot');
            tbody.innerHTML = '';
            tfoot.innerHTML = '';

            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const pageData = filteredData.slice(start, end);

            pageData.forEach(row => {
                const tr = document.createElement('tr');
                if (row.paymentStatus === 'Pending') tr.classList.add('pending');
                else if (row.paymentStatus === 'Paid') tr.classList.add('paid');

                columns.forEach(col => {
                    const td = document.createElement('td');
                    if (col === 'Invoice PDF') {
                        const btn = document.createElement('button');
                        btn.textContent = 'Download';
                        btn.onclick = () => downloadInvoice(row.invoiceNo);
                        td.appendChild(btn);
                    } else if (col === 'Items') {
                        const items = (row.items || '').split(',').map(i => i.trim()).filter(Boolean).sort();
                        td.innerHTML = items.map(i => `<span class="item-link">${escapeHtml(i)}</span>`).join('<br>');
                    } else if (['Subtotal', 'Discount', 'Tax', 'Grand Total'].includes(col)) {
                        const key = convertColumn(col);
                        td.textContent = `â‚¹${(parseFloat(row[key]) || 0).toFixed(2)}`;
                    } else if (col === 'Date') {
                        td.textContent = row.dateObj ? formatDisplayDate(row.dateObj) : (row.date || '');
                    } else if (col === 'Delivery Date') {
                        td.textContent = row.deliveryDateObj ? formatDisplayDate(row.deliveryDateObj) : (row.deliveryDate || '');
                    } else if (col === 'Delivery Time') {
                        if (row.deliveryDateObj instanceof Date && !isNaN(row.deliveryDateObj)) {
                            td.textContent = row.deliveryDateObj.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
                        } else {
                            td.textContent = row.deliveryTime || '';
                        }
                    } else {
                        const key = convertColumn(col);
                        const val = row[key] == null ? '' : String(row[key]);
                        td.textContent = val.length > 30 ? val.slice(0, 30) + '...' : val;
                        if (val.length > 30) td.title = val;
                    }
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });

            const total = filteredData.reduce((s, r) => s + (parseFloat(r.grandTotal) || 0), 0);
            if (total > 0) {
                const trTotal = document.createElement('tr');
                trTotal.classList.add('total-row');
                const tdTotal = document.createElement('td');
                tdTotal.colSpan = columns.length;
                tdTotal.textContent = 'Grand Total: â‚¹' + total.toFixed(2);
                trTotal.appendChild(tdTotal);
                tfoot.appendChild(trTotal);
            }

            renderPagination();
        }

        function convertColumn(col) {
            return {
                "Date": "date",
                "Invoice No": "invoiceNo",
                "Customer Name": "customerName",
                "Email": "email",
                "Items": "items",
                "Subtotal": "subtotal",
                "Discount": "discount",
                "Tax": "tax",
                "Grand Total": "grandTotal",
                "Payment Status": "paymentStatus",
                "Notes": "notes",
                "Invoice PDF": "invoiceNo",
                "Delivery Date": "deliveryDate",
                "Delivery Time": "deliveryTime",
                "Delivery Status": "deliveryStatus"
            }[col];
        }

        function renderPagination() {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';
            const totalPages = Math.max(1, Math.ceil(filteredData.length / rowsPerPage));
            for (let i = 1; i <= totalPages; i++) {
                const btn = document.createElement('button');
                btn.textContent = i;
                if (i === currentPage) btn.classList.add('active-page');
                btn.addEventListener('click', () => { currentPage = i; displayTable(); });
                pagination.appendChild(btn);
            }
        }

        function sortByColumn(col) {
            const key = convertColumn(col);
            sortAsc = (sortColumn === key) ? !sortAsc : false;
            sortColumn = key;

            filteredData.sort((a, b) => {
                if (key === 'date') {
                    const av = a.dateObj ? a.dateObj.getTime() : -Infinity;
                    const bv = b.dateObj ? b.dateObj.getTime() : -Infinity;
                    return sortAsc ? av - bv : bv - av;
                }
                const va = a[key] ?? '';
                const vb = b[key] ?? '';
                const na = parseFloat(va);
                const nb = parseFloat(vb);
                if (!isNaN(na) && !isNaN(nb)) return sortAsc ? na - nb : nb - na;
                const sa = String(va).toLowerCase();
                const sb = String(vb).toLowerCase();
                return sortAsc ? sa.localeCompare(sb) : sb.localeCompare(sa);
            });

            currentPage = 1;
            displayTable();
        }

        // ----------------------
        // ðŸ”¹ Filtering
        // ----------------------
        function loadOrders(reset = false) {
            if (reset) {
                document.getElementById('searchInput').value = '';
                document.getElementById('paymentFilter').value = '';
                document.getElementById('dateFrom').value = '';
                document.getElementById('dateTo').value = '';
            }

            const searchValue = document.getElementById('searchInput').value.trim().toLowerCase();
            const paymentValue = document.getElementById('paymentFilter').value;
            const dateFrom = document.getElementById('dateFrom').value ? new Date(document.getElementById('dateFrom').value + 'T00:00:00') : null;
            const dateTo = document.getElementById('dateTo').value ? new Date(document.getElementById('dateTo').value + 'T23:59:59') : null;

            filteredData = allData.filter(r => {
                const searchMatch = !searchValue ||
                    (r.customerName || '').toLowerCase().includes(searchValue) ||
                    (r.email || '').toLowerCase().includes(searchValue);

                let dateMatch = true;
                let paymentMatch = true;

                if (activeTab === 'delivered') {
                    // Delivered Orders (Orders sheet)
                    if (paymentValue) paymentMatch = r.paymentStatus === paymentValue;
                    if (dateFrom || dateTo) {
                        const d = r.dateObj;
                        if (!d) return false;
                        if (dateFrom && d < dateFrom) dateMatch = false;
                        if (dateTo && d > dateTo) dateMatch = false;
                    }
                } else {
                    // Upcoming Orders (Future Orders sheet)
                    const d = r.deliveryDateObj;
                    if (dateFrom || dateTo) {
                        if (!d) return false;
                        if (dateFrom && d < dateFrom) dateMatch = false;
                        if (dateTo && d > dateTo) dateMatch = false;
                    }
                }

                return searchMatch && paymentMatch && dateMatch;
            });

            filteredData = filteredData.slice().reverse();
            currentPage = 1;
            displayTable();
        }

        // ----------------------
        // ðŸ”¹ Invoice Download
        // ----------------------
        async function downloadInvoice(invoiceNo) {
            try {
                const res = await fetch(`${APPS_SCRIPT_URL}?invoice=${encodeURIComponent(invoiceNo)}`);
                const data = await res.json();
                if (data && data.url) window.open(data.url, '_blank');
                else alert('Invoice PDF not found.');
            } catch (err) {
                console.error(err);
                alert('Error fetching invoice PDF.');
            }
        }

        // ----------------------
        // ðŸ”¹ Tab Switching
        // ----------------------
        function switchTab(tab) {
            activeTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');

            // Show payment filter only for delivered orders
            document.getElementById('paymentFilterWrapper').style.display = (tab === 'delivered') ? 'block' : 'none';

            // Fetch corresponding sheet
            if (tab === 'orders') fetchOrders('Future Orders');      // Upcoming
            else if (tab === 'delivered') fetchOrders('Orders');     // Completed
        }

        // ----------------------
        // ðŸ”¹ Event Listeners
        // ----------------------
        document.getElementById('searchInput').addEventListener('input', () => loadOrders());
        document.getElementById('paymentFilter').addEventListener('change', () => loadOrders());
        document.getElementById('dateFrom').addEventListener('change', () => loadOrders());
        document.getElementById('dateTo').addEventListener('change', () => loadOrders());

        // Load default tab
        fetchOrders('Orders');
    </script>

</body>

</html>